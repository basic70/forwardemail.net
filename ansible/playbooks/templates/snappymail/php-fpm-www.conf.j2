; ForwardEmail SnappyMail PHP-FPM Pool Configuration
; ===================================================
; Optimized for high-concurrency mail service

[www]

; User and Group
user = www-data
group = www-data

; Listen on Unix socket for better performance than TCP
listen = /run/php/php8.2-fpm.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; Process Manager Configuration
; =============================
; Dynamic mode allows scaling based on demand
pm = dynamic

; Maximum number of child processes
; Increase from default 50 to handle more concurrent users
pm.max_children = {{ lookup('env', 'MAIL_PHP_MAX_CHILDREN') | default('200') }}

; Number of child processes created on startup
pm.start_servers = {{ lookup('env', 'MAIL_PHP_START_SERVERS') | default('20') }}

; Minimum number of idle server processes
pm.min_spare_servers = {{ lookup('env', 'MAIL_PHP_MIN_SPARE') | default('10') }}

; Maximum number of idle server processes
pm.max_spare_servers = {{ lookup('env', 'MAIL_PHP_MAX_SPARE') | default('30') }}

; Number of seconds after which an idle process will be killed
pm.process_idle_timeout = 30s

; Number of requests each child process should execute before respawning
; Helps prevent memory leaks over time
pm.max_requests = {{ lookup('env', 'MAIL_PHP_MAX_REQUESTS') | default('1000') }}

; Status monitoring endpoint
pm.status_path = /status

; Ping endpoint for health checks
ping.path = /ping
ping.response = pong

; Performance Tuning
; ==================

; Allow child processes to reach 128MB memory limit
php_admin_value[memory_limit] = {{ lookup('env', 'MAIL_PHP_MEMORY_LIMIT') | default('128M') }}

; Request timeout (should be higher than IMAP timeout)
request_terminate_timeout = 60s

; Slow request logging for debugging performance issues
request_slowlog_timeout = 10s
slowlog = /var/log/php-fpm/snappymail-slow.log

; Logging
; =======

; Error log location
php_admin_value[error_log] = /var/log/php-fpm/snappymail-error.log
php_admin_flag[log_errors] = on

; Catch worker output
catch_workers_output = yes

; Security
; ========

; Limit allowed file operations to specific paths
php_admin_value[open_basedir] = {{ lookup('env', 'MAIL_APP_PATH') | default('/var/www/snappymail') }}:/tmp

; Disable dangerous PHP functions
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

; Environment Variables
; =====================

; Pass environment variables to PHP
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

; SnappyMail specific data folder path
env[APP_DATA_FOLDER_PATH] = {{ lookup('env', 'MAIL_APP_PATH') | default('/var/www/snappymail') }}/data
